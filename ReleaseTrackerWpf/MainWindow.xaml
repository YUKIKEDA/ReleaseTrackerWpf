<ui:FluentWindow
    x:Class="ReleaseTrackerWpf.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:converters="clr-namespace:ReleaseTrackerWpf.Converters"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:local="clr-namespace:ReleaseTrackerWpf"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
    xmlns:viewmodels="clr-namespace:ReleaseTrackerWpf.ViewModels"
    Title="ReleaseTracker"
    Width="1200"
    Height="800"
    MinWidth="800"
    MinHeight="600"
    WindowStartupLocation="CenterScreen"
    mc:Ignorable="d">

    <ui:FluentWindow.Resources>
        <converters:DifferenceTypeToColorConverter x:Key="DifferenceTypeToColorConverter" />
        <converters:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />
    </ui:FluentWindow.Resources>

    <Grid Background="{StaticResource ApplicationBackgroundBrush}">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!--  Title Bar  -->
        <ui:TitleBar
            Title="ReleaseTracker"
            Grid.Row="0"
            Height="28"
            Background="{StaticResource TitleBarBackgroundBrush}"
            FontSize="14"
            FontWeight="Bold">
            <ui:TitleBar.Icon>
                <ui:SymbolIcon FontSize="18" Symbol="Home16" />
            </ui:TitleBar.Icon>
        </ui:TitleBar>

        <!--  Tab Control  -->
        <TabControl
            Grid.Row="1"
            Margin="10"
            Background="{StaticResource ApplicationBackgroundBrush}">
            <!--  Main Tab  -->
            <TabItem Header="メイン">
                <Grid Margin="10">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>

                    <!--  Control Panel  -->
                    <ui:Card Grid.Row="0" Margin="0,0,0,10">
                        <Grid Margin="0">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                            </Grid.RowDefinitions>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>

                            <!--  Snapshot Add Button (Top Right)  -->
                            <ui:Button
                                Grid.Row="0"
                                Grid.Column="1"
                                Margin="0,0,0,10"
                                HorizontalAlignment="Right"
                                VerticalAlignment="Top"
                                Command="{Binding ScanAndAddNewStructureCommand}"
                                Content="スナップショット追加"
                                Visibility="{Binding HasSnapshots, Converter={StaticResource BooleanToVisibilityConverter}}" />

                            <!--  Divider  -->
                            <Separator
                                Grid.Row="1"
                                Grid.Column="0"
                                Grid.ColumnSpan="2"
                                Margin="0,0,0,10"
                                Visibility="{Binding HasSnapshots, Converter={StaticResource BooleanToVisibilityConverter}}" />

                            <!--  Headers  -->
                            <TextBlock
                                Grid.Row="2"
                                Grid.Column="0"
                                Margin="0,0,0,10"
                                FontSize="16"
                                FontWeight="Bold"
                                Text="比較元"
                                Visibility="{Binding HasSnapshots, Converter={StaticResource BooleanToVisibilityConverter}}" />
                            <TextBlock
                                Grid.Row="2"
                                Grid.Column="1"
                                Margin="0,0,0,10"
                                FontSize="16"
                                FontWeight="Bold"
                                Text="比較先"
                                Visibility="{Binding HasSnapshots, Converter={StaticResource BooleanToVisibilityConverter}}" />

                            <!--  Old Structure Selection  -->
                            <StackPanel
                                Grid.Row="3"
                                Grid.Column="0"
                                Margin="0,0,10,0">
                                <ComboBox
                                    Margin="0,0,0,10"
                                    ItemsSource="{Binding AvailableSnapshots}"
                                    SelectedItem="{Binding SelectedOldSnapshot}"
                                    Visibility="{Binding HasSnapshots, Converter={StaticResource BooleanToVisibilityConverter}}">
                                    <ComboBox.ItemTemplate>
                                        <DataTemplate>
                                            <StackPanel>
                                                <TextBlock FontWeight="Bold" Text="{Binding RootPath}" />
                                                <TextBlock
                                                    FontSize="11"
                                                    Foreground="Gray"
                                                    Text="{Binding CreatedAt, StringFormat='作成日時: {0:yyyy/MM/dd HH:mm}'}" />
                                            </StackPanel>
                                        </DataTemplate>
                                    </ComboBox.ItemTemplate>
                                </ComboBox>
                            </StackPanel>

                            <!--  New Structure Selection  -->
                            <StackPanel
                                Grid.Row="3"
                                Grid.Column="1"
                                Margin="10,0,0,0">
                                <ComboBox
                                    Margin="0,0,0,10"
                                    ItemsSource="{Binding AvailableSnapshots}"
                                    SelectedItem="{Binding SelectedNewSnapshot}"
                                    Visibility="{Binding HasSnapshots, Converter={StaticResource BooleanToVisibilityConverter}}">
                                    <ComboBox.ItemTemplate>
                                        <DataTemplate>
                                            <StackPanel>
                                                <TextBlock FontWeight="Bold" Text="{Binding RootPath}" />
                                                <TextBlock
                                                    FontSize="11"
                                                    Foreground="Gray"
                                                    Text="{Binding CreatedAt, StringFormat='作成日時: {0:yyyy/MM/dd HH:mm}'}" />
                                            </StackPanel>
                                        </DataTemplate>
                                    </ComboBox.ItemTemplate>
                                </ComboBox>
                            </StackPanel>

                            <!--  First Time Snapshot Creation Button (Centered)  -->
                            <StackPanel
                                Grid.Row="0"
                                Grid.Column="0"
                                Grid.ColumnSpan="2"
                                HorizontalAlignment="Center"
                                VerticalAlignment="Center"
                                Visibility="{Binding HasNoSnapshots, Converter={StaticResource BooleanToVisibilityConverter}}">
                                <ui:Button
                                    Padding="40,20"
                                    HorizontalAlignment="Center"
                                    Command="{Binding BrowseFirstTimeDirectoryCommand}"
                                    Content="スナップショット作成"
                                    FontSize="18"
                                    FontWeight="Bold" />
                                <TextBlock
                                    Margin="0,10,0,0"
                                    HorizontalAlignment="Center"
                                    FontSize="14"
                                    Foreground="Gray"
                                    Text="フォルダを選択してスナップショットを作成してください" />
                            </StackPanel>

                        </Grid>
                    </ui:Card>

                    <!--  Results Area  -->
                    <ui:Card Grid.Row="1" VerticalAlignment="Top">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                            </Grid.RowDefinitions>

                            <StackPanel
                                Grid.Row="0"
                                Margin="20,20,20,10"
                                Orientation="Horizontal">
                                <TextBlock
                                    VerticalAlignment="Center"
                                    FontSize="16"
                                    FontWeight="Bold"
                                    Text="比較結果" />
                                <StackPanel Margin="20,0,0,0" Orientation="Horizontal">
                                    <ui:Button
                                        Margin="0,0,5,0"
                                        Command="{Binding ExportResultsCommand}"
                                        Content="エクスポート" />
                                    <ui:Button
                                        Margin="5,0,0,0"
                                        Command="{Binding ImportDescriptionsCommand}"
                                        Content="説明インポート" />
                                </StackPanel>
                            </StackPanel>

                            <TreeView
                                Grid.Row="1"
                                MaxHeight="400"
                                Margin="20,0,20,20"
                                VerticalAlignment="Top"
                                ItemsSource="{Binding ComparisonResults}">
                                <TreeView.ItemTemplate>
                                    <HierarchicalDataTemplate ItemsSource="{Binding Children}">
                                        <StackPanel Orientation="Horizontal">
                                            <!--  Status Icon with Tooltip  -->
                                            <ui:SymbolIcon
                                                Margin="0,0,8,0"
                                                VerticalAlignment="Center"
                                                FontSize="12"
                                                Symbol="Add12"
                                                ToolTip="追加されたファイル">
                                                <ui:SymbolIcon.Style>
                                                    <Style TargetType="ui:SymbolIcon">
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding DifferenceType}" Value="Added">
                                                                <Setter Property="Symbol" Value="Add12" />
                                                                <Setter Property="Foreground" Value="#007800" />
                                                                <Setter Property="ToolTip" Value="追加されたファイル" />
                                                            </DataTrigger>
                                                            <DataTrigger Binding="{Binding DifferenceType}" Value="Deleted">
                                                                <Setter Property="Symbol" Value="Subtract12" />
                                                                <Setter Property="Foreground" Value="#B40000" />
                                                                <Setter Property="ToolTip" Value="削除されたファイル" />
                                                            </DataTrigger>
                                                            <DataTrigger Binding="{Binding DifferenceType}" Value="Modified">
                                                                <Setter Property="Symbol" Value="Edit12" />
                                                                <Setter Property="Foreground" Value="#C86400" />
                                                                <Setter Property="ToolTip" Value="変更されたファイル" />
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </ui:SymbolIcon.Style>
                                            </ui:SymbolIcon>

                                            <TextBlock
                                                VerticalAlignment="Center"
                                                FontWeight="Bold"
                                                Foreground="{Binding DifferenceType, Converter={StaticResource DifferenceTypeToColorConverter}}"
                                                Text="{Binding Name}" />

                                            <TextBlock
                                                Margin="10,0,0,0"
                                                VerticalAlignment="Center"
                                                FontSize="11"
                                                Foreground="Gray"
                                                Text="{Binding DisplaySize}" />

                                            <TextBlock
                                                Margin="10,0,0,0"
                                                VerticalAlignment="Center"
                                                FontStyle="Italic"
                                                Foreground="DarkBlue"
                                                Text="{Binding Description}"
                                                Visibility="{Binding Description, Converter={StaticResource BooleanToVisibilityConverter}}" />
                                        </StackPanel>
                                    </HierarchicalDataTemplate>
                                </TreeView.ItemTemplate>
                            </TreeView>
                        </Grid>
                    </ui:Card>
                </Grid>
            </TabItem>

            <!--  Settings Tab  -->
            <TabItem Header="設定">
                <ui:Card Margin="10" VerticalAlignment="Top">
                    <StackPanel Margin="20">
                        <TextBlock
                            Margin="0,0,0,20"
                            FontSize="18"
                            FontWeight="Bold"
                            Text="アプリケーション設定" />

                        <!--  Auto Scan Settings  -->
                        <GroupBox Margin="0,0,0,15" Header="自動スキャン設定">
                            <StackPanel Margin="10">
                                <CheckBox
                                    Margin="0,0,0,10"
                                    Content="自動スキャンを有効にする"
                                    IsChecked="{Binding AutoScanEnabled}" />

                                <TextBlock
                                    FontSize="11"
                                    Foreground="Gray"
                                    Text="※ フォルダパス変更後、自動でスキャンを開始します" />
                            </StackPanel>
                        </GroupBox>

                        <!--  Storage Settings  -->
                        <GroupBox Margin="0,0,0,15" Header="保存設定">
                            <StackPanel Margin="10">
                                <StackPanel Margin="0,0,0,10" Orientation="Horizontal">
                                    <TextBlock VerticalAlignment="Center" Text="スナップショット保存先: " />
                                    <Grid Margin="5,0,0,0">
                                        <TextBox
                                            Width="600"
                                            Padding="8,8,40,8"
                                            IsReadOnly="True"
                                            Text="{Binding SnapshotsDirectory}" />
                                        <ui:Button
                                            Width="24"
                                            Height="24"
                                            Margin="0,0,8,0"
                                            Padding="0"
                                            HorizontalAlignment="Right"
                                            VerticalAlignment="Center"
                                            Background="Transparent"
                                            BorderThickness="0"
                                            Click="ChangeSnapshotsFolder_Click"
                                            ToolTip="保存先を変更">
                                            <ui:SymbolIcon FontSize="14" Symbol="FolderOpen16" />
                                        </ui:Button>
                                    </Grid>
                                </StackPanel>

                                <ui:Button
                                    Margin="0,5,0,0"
                                    HorizontalAlignment="Left"
                                    Click="OpenSnapshotsFolder_Click"
                                    Content="保存先フォルダを開く" />
                            </StackPanel>
                        </GroupBox>

                        <!--  Snapshot Management  -->
                        <GroupBox Margin="0,0,0,15" Header="スナップショット管理">
                            <StackPanel Margin="10">
                                <ui:Button
                                    Margin="0,0,0,10"
                                    Command="{Binding CreateNewSnapshotCommand}"
                                    Content="新しいスナップショットを作成" />

                                <TextBlock
                                    FontSize="11"
                                    Foreground="Gray"
                                    Text="※ フォルダを選択して新しいスナップショットを作成できます" />
                            </StackPanel>
                        </GroupBox>

                        <!--  About  -->
                        <GroupBox Header="バージョン情報">
                            <StackPanel Margin="10">
                                <TextBlock
                                    FontSize="14"
                                    FontWeight="Bold"
                                    Text="ReleaseTracker" />
                                <TextBlock Margin="0,5,0,0" Text="Version 1.0.0" />
                                <TextBlock
                                    Margin="0,5,0,0"
                                    Foreground="Gray"
                                    Text="ディレクトリ構造比較ツール" />
                            </StackPanel>
                        </GroupBox>
                    </StackPanel>
                </ui:Card>
            </TabItem>
        </TabControl>

        <!--  Status Bar  -->
        <Border
            Grid.Row="2"
            Margin="10,0,10,10"
            Background="{StaticResource StatusBarBackgroundBrush}"
            CornerRadius="4">
            <ui:InfoBar
                Title="{Binding StatusMessage}"
                Background="Transparent"
                IsClosable="False"
                IsOpen="True"
                Severity="Informational">
                <ui:InfoBar.Content>
                    <ui:ProgressRing
                        Width="16"
                        Height="16"
                        IsIndeterminate="True"
                        Visibility="{Binding IsProcessing, Converter={StaticResource BooleanToVisibilityConverter}}" />
                </ui:InfoBar.Content>
            </ui:InfoBar>
        </Border>
    </Grid>
</ui:FluentWindow>