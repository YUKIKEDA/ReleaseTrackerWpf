<ui:FluentWindow x:Class="ReleaseTrackerWpf.MainWindow"
                 xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                 xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                 xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
                 xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
                 xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
                 xmlns:local="clr-namespace:ReleaseTrackerWpf"
                 xmlns:converters="clr-namespace:ReleaseTrackerWpf.Converters"
                 xmlns:viewmodels="clr-namespace:ReleaseTrackerWpf.ViewModels"
                 mc:Ignorable="d"
                 Title="ReleaseTracker"
                 Height="800" Width="1200"
                 MinHeight="600" MinWidth="800"
                 WindowStartupLocation="CenterScreen">

    <ui:FluentWindow.Resources>
        <converters:DifferenceTypeToColorConverter x:Key="DifferenceTypeToColorConverter"/>
        <converters:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
    </ui:FluentWindow.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Title Bar -->
        <ui:TitleBar Grid.Row="0" Title="ReleaseTracker"/>

        <!-- Tab Control -->
        <TabControl Grid.Row="1" Margin="10">
            <!-- Main Tab -->
            <TabItem Header="メイン">
                <Grid Margin="10">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- Control Panel -->
                    <ui:Card Grid.Row="0" Margin="0,0,0,10">
                        <Grid Margin="20">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <!-- Headers -->
                            <TextBlock Grid.Row="0" Grid.Column="0" Text="旧構造 (比較元)" FontWeight="Bold" FontSize="16" Margin="0,0,0,10"/>
                            <TextBlock Grid.Row="0" Grid.Column="1" Text="新構造 (比較先)" FontWeight="Bold" FontSize="16" Margin="0,0,0,10"/>

                            <!-- Old Structure Selection -->
                            <StackPanel Grid.Row="1" Grid.Column="0" Margin="0,0,10,0">
                                <ComboBox ItemsSource="{Binding AvailableSnapshots}"
                                          SelectedItem="{Binding SelectedOldSnapshot}"
                                          Margin="0,0,0,10"
                                          Visibility="{Binding HasSnapshots, Converter={StaticResource BooleanToVisibilityConverter}}">
                                    <ComboBox.ItemTemplate>
                                        <DataTemplate>
                                            <StackPanel>
                                                <TextBlock Text="{Binding RootPath}" FontWeight="Bold"/>
                                                <TextBlock Text="{Binding CreatedAt, StringFormat='作成日時: {0:yyyy/MM/dd HH:mm}'}"
                                                          FontSize="11" Foreground="Gray"/>
                                            </StackPanel>
                                        </DataTemplate>
                                    </ComboBox.ItemTemplate>
                                </ComboBox>
                                <ui:Button Content="初回スナップショット作成"
                                          Command="{Binding BrowseFirstTimeDirectoryCommand}"
                                          Visibility="{Binding HasNoSnapshots, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                            </StackPanel>

                            <!-- New Structure Controls -->
                            <StackPanel Grid.Row="1" Grid.Column="1" Margin="10,0,0,0">
                                <Grid Margin="0,0,0,10">
                                    <ui:TextBox Text="{Binding NewDirectoryPath}"
                                               PlaceholderText="フォルダパス（自動スキャン）"
                                               Padding="8,8,40,8"/>
                                    <ui:Button Command="{Binding BrowseNewDirectoryCommand}"
                                              HorizontalAlignment="Right"
                                              VerticalAlignment="Center"
                                              Margin="0,0,8,0"
                                              Width="24" Height="24"
                                              Padding="0"
                                              Background="Transparent"
                                              BorderThickness="0">
                                        <ui:SymbolIcon Symbol="FolderOpen16" FontSize="14"/>
                                    </ui:Button>
                                </Grid>
                            </StackPanel>

                        </Grid>
                    </ui:Card>

                    <!-- Results Area -->
                    <ui:Card Grid.Row="1" VerticalAlignment="Top">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>

                            <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="20,20,20,10">
                                <TextBlock Text="比較結果" FontWeight="Bold" FontSize="16" VerticalAlignment="Center"/>
                                <StackPanel Orientation="Horizontal" Margin="20,0,0,0">
                                    <ui:Button Content="エクスポート" Command="{Binding ExportResultsCommand}" Margin="0,0,5,0"/>
                                    <ui:Button Content="説明インポート" Command="{Binding ImportDescriptionsCommand}" Margin="5,0,0,0"/>
                                </StackPanel>
                            </StackPanel>

                            <TreeView Grid.Row="1"
                                      ItemsSource="{Binding ComparisonResults}"
                                      Margin="20,0,20,20"
                                      VerticalAlignment="Top"
                                      MaxHeight="400">
                                <TreeView.ItemTemplate>
                                    <HierarchicalDataTemplate ItemsSource="{Binding Children}">
                                        <StackPanel Orientation="Horizontal">
                                            <!-- Status Icon with Tooltip -->
                                            <ui:SymbolIcon Symbol="Add12"
                                                           FontSize="12"
                                                           Margin="0,0,8,0"
                                                           VerticalAlignment="Center"
                                                           ToolTip="追加されたファイル">
                                                <ui:SymbolIcon.Style>
                                                    <Style TargetType="ui:SymbolIcon">
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding DifferenceType}" Value="Added">
                                                                <Setter Property="Symbol" Value="Add12"/>
                                                                <Setter Property="Foreground" Value="#007800"/>
                                                                <Setter Property="ToolTip" Value="追加されたファイル"/>
                                                            </DataTrigger>
                                                            <DataTrigger Binding="{Binding DifferenceType}" Value="Deleted">
                                                                <Setter Property="Symbol" Value="Subtract12"/>
                                                                <Setter Property="Foreground" Value="#B40000"/>
                                                                <Setter Property="ToolTip" Value="削除されたファイル"/>
                                                            </DataTrigger>
                                                            <DataTrigger Binding="{Binding DifferenceType}" Value="Modified">
                                                                <Setter Property="Symbol" Value="Edit12"/>
                                                                <Setter Property="Foreground" Value="#C86400"/>
                                                                <Setter Property="ToolTip" Value="変更されたファイル"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </ui:SymbolIcon.Style>
                                            </ui:SymbolIcon>

                                            <TextBlock Text="{Binding Name}"
                                                       Foreground="{Binding DifferenceType, Converter={StaticResource DifferenceTypeToColorConverter}}"
                                                       FontWeight="Bold"
                                                       VerticalAlignment="Center"/>

                                            <TextBlock Text="{Binding DisplaySize}"
                                                       Margin="10,0,0,0"
                                                       FontSize="11"
                                                       VerticalAlignment="Center"
                                                       Foreground="Gray"/>

                                            <TextBlock Text="{Binding Description}"
                                                       Margin="10,0,0,0"
                                                       FontStyle="Italic"
                                                       Foreground="DarkBlue"
                                                       VerticalAlignment="Center"
                                                       Visibility="{Binding Description, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                                        </StackPanel>
                                    </HierarchicalDataTemplate>
                                </TreeView.ItemTemplate>
                            </TreeView>
                        </Grid>
                    </ui:Card>
                </Grid>
            </TabItem>

            <!-- Settings Tab -->
            <TabItem Header="設定">
                <ui:Card Margin="10" VerticalAlignment="Top">
                    <StackPanel Margin="20">
                        <TextBlock Text="アプリケーション設定" FontWeight="Bold" FontSize="18" Margin="0,0,0,20"/>

                        <!-- Auto Scan Settings -->
                        <GroupBox Header="自動スキャン設定" Margin="0,0,0,15">
                            <StackPanel Margin="10">
                                <CheckBox Content="自動スキャンを有効にする"
                                         IsChecked="{Binding AutoScanEnabled}"
                                         Margin="0,0,0,10"/>

                                <TextBlock Text="※ フォルダパス変更後、自動でスキャンを開始します"
                                          FontSize="11" Foreground="Gray"/>
                            </StackPanel>
                        </GroupBox>

                        <!-- Storage Settings -->
                        <GroupBox Header="保存設定" Margin="0,0,0,15">
                            <StackPanel Margin="10">
                                <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                                    <TextBlock Text="スナップショット保存先: " VerticalAlignment="Center"/>
                                    <Grid Margin="5,0,0,0">
                                        <TextBox Text="{Binding SnapshotsDirectory}"
                                                Width="400"
                                                IsReadOnly="True"
                                                Padding="8,8,40,8"/>
                                        <ui:Button Click="ChangeSnapshotsFolder_Click"
                                                  HorizontalAlignment="Right"
                                                  VerticalAlignment="Center"
                                                  Margin="0,0,8,0"
                                                  Width="24" Height="24"
                                                  Padding="0"
                                                  Background="Transparent"
                                                  BorderThickness="0"
                                                  ToolTip="保存先を変更">
                                            <ui:SymbolIcon Symbol="FolderOpen16" FontSize="14"/>
                                        </ui:Button>
                                    </Grid>
                                </StackPanel>

                                <ui:Button Content="保存先フォルダを開く"
                                          Click="OpenSnapshotsFolder_Click"
                                          Margin="0,5,0,0"
                                          HorizontalAlignment="Left"/>
                            </StackPanel>
                        </GroupBox>

                        <!-- About -->
                        <GroupBox Header="バージョン情報">
                            <StackPanel Margin="10">
                                <TextBlock Text="ReleaseTracker" FontWeight="Bold" FontSize="14"/>
                                <TextBlock Text="Version 1.0.0" Margin="0,5,0,0"/>
                                <TextBlock Text="ディレクトリ構造比較ツール" Margin="0,5,0,0" Foreground="Gray"/>
                            </StackPanel>
                        </GroupBox>
                    </StackPanel>
                </ui:Card>
            </TabItem>
        </TabControl>

        <!-- Status Bar -->
        <ui:InfoBar Grid.Row="2"
                    Title="{Binding StatusMessage}"
                    IsOpen="True"
                    Severity="Informational"
                    IsClosable="False"
                    Margin="10,0,10,10">
            <ui:InfoBar.Content>
                <ui:ProgressRing IsIndeterminate="True"
                                 Visibility="{Binding IsProcessing, Converter={StaticResource BooleanToVisibilityConverter}}"
                                 Width="16" Height="16"/>
            </ui:InfoBar.Content>
        </ui:InfoBar>
    </Grid>
</ui:FluentWindow>