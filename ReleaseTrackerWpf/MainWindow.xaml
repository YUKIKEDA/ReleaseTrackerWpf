<ui:FluentWindow x:Class="ReleaseTrackerWpf.MainWindow"
                 xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                 xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                 xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
                 xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
                 xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
                 xmlns:local="clr-namespace:ReleaseTrackerWpf"
                 xmlns:converters="clr-namespace:ReleaseTrackerWpf.Converters"
                 xmlns:viewmodels="clr-namespace:ReleaseTrackerWpf.ViewModels"
                 mc:Ignorable="d"
                 Title="ReleaseTracker"
                 Height="800" Width="1200"
                 MinHeight="600" MinWidth="800"
                 WindowStartupLocation="CenterScreen">

    <ui:FluentWindow.Resources>
        <converters:DifferenceTypeToColorConverter x:Key="DifferenceTypeToColorConverter"/>
        <converters:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
    </ui:FluentWindow.Resources>

    <Grid Background="{StaticResource ApplicationBackgroundBrush}">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Title Bar -->
        <ui:TitleBar Grid.Row="0" Title="ReleaseTracker" Height="28" Background="{StaticResource TitleBarBackgroundBrush}"
                     FontWeight="Bold" FontSize="14">
            <ui:TitleBar.Icon>
                <ui:SymbolIcon Symbol="Home16" FontSize="18"/>
            </ui:TitleBar.Icon>
        </ui:TitleBar>

        <!-- Tab Control -->
        <TabControl Grid.Row="1" Margin="10" Background="{StaticResource ApplicationBackgroundBrush}">
            <!-- Main Tab -->
            <TabItem Header="メイン">
                <Grid Margin="10">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- Control Panel -->
                    <ui:Card Grid.Row="0" Margin="0,0,0,10">
                        <Grid Margin="20">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <!-- Headers -->
                            <TextBlock Grid.Row="0" Grid.Column="0" Text="旧構造 (比較元)" FontWeight="Bold" FontSize="16" Margin="0,0,0,10"/>
                            <TextBlock Grid.Row="0" Grid.Column="1" Text="新構造 (比較先)" FontWeight="Bold" FontSize="16" Margin="0,0,0,10"/>

                            <!-- Old Structure Selection -->
                            <StackPanel Grid.Row="1" Grid.Column="0" Margin="0,0,10,0">
                                <ComboBox ItemsSource="{Binding AvailableSnapshots}"
                                          SelectedItem="{Binding SelectedOldSnapshot}"
                                          Margin="0,0,0,10"
                                          Visibility="{Binding HasSnapshots, Converter={StaticResource BooleanToVisibilityConverter}}">
                                    <ComboBox.ItemTemplate>
                                        <DataTemplate>
                                            <StackPanel>
                                                <TextBlock Text="{Binding RootPath}" FontWeight="Bold"/>
                                                <TextBlock Text="{Binding CreatedAt, StringFormat='作成日時: {0:yyyy/MM/dd HH:mm}'}"
                                                          FontSize="11" Foreground="Gray"/>
                                            </StackPanel>
                                        </DataTemplate>
                                    </ComboBox.ItemTemplate>
                                </ComboBox>
                                <ui:Button Content="初回スナップショット作成"
                                          Command="{Binding BrowseFirstTimeDirectoryCommand}"
                                          Visibility="{Binding HasNoSnapshots, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                            </StackPanel>

                            <!-- New Structure Selection -->
                            <StackPanel Grid.Row="1" Grid.Column="1" Margin="10,0,0,0">
                                <ComboBox ItemsSource="{Binding AvailableSnapshots}"
                                          SelectedItem="{Binding SelectedNewSnapshot}"
                                          Margin="0,0,0,10"
                                          Visibility="{Binding HasSnapshots, Converter={StaticResource BooleanToVisibilityConverter}}">
                                    <ComboBox.ItemTemplate>
                                        <DataTemplate>
                                            <StackPanel>
                                                <TextBlock Text="{Binding RootPath}" FontWeight="Bold"/>
                                                <TextBlock Text="{Binding CreatedAt, StringFormat='作成日時: {0:yyyy/MM/dd HH:mm}'}"
                                                          FontSize="11" Foreground="Gray"/>
                                            </StackPanel>
                                        </DataTemplate>
                                    </ComboBox.ItemTemplate>
                                </ComboBox>
                                <ui:Button Content="新構造をスキャンして追加"
                                          Command="{Binding ScanAndAddNewStructureCommand}"
                                          Visibility="{Binding HasSnapshots, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                            </StackPanel>

                        </Grid>
                    </ui:Card>

                    <!-- Results Area -->
                    <ui:Card Grid.Row="1" VerticalAlignment="Top">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>

                            <!-- ヘッダーとボタン -->
                            <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="20,20,20,10">
                                <TextBlock Text="比較結果" FontWeight="Bold" FontSize="16" VerticalAlignment="Center"/>
                                <StackPanel Orientation="Horizontal" Margin="20,0,0,0">
                                    <ui:Button Content="エクスポート" Command="{Binding ExportResultsCommand}" Margin="0,0,5,0"/>
                                    <ui:Button Content="説明インポート" Command="{Binding ImportDescriptionsCommand}" Margin="5,0,0,0"/>
                                </StackPanel>
                            </StackPanel>

                            <!-- 左右比較レイアウト -->
                            <Grid Grid.Row="1" Margin="20,0,20,20">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="5"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>

                                <!-- 左側：旧構造 -->
                                <ui:Card Grid.Column="0" VerticalAlignment="Top">
                                    <Grid>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="*"/>
                                        </Grid.RowDefinitions>

                                        <Border Grid.Row="0" Background="#FFE6E6" Padding="10">
                                            <StackPanel Orientation="Horizontal">
                                                <ui:SymbolIcon Symbol="Delete16" Foreground="#B40000" Margin="0,0,8,0"/>
                                                <TextBlock Text="旧構造" FontWeight="Bold" Foreground="#B40000"/>
                                            </StackPanel>
                                        </Border>

                                        <TreeView Grid.Row="1"
                                                  ItemsSource="{Binding OldStructureTree}"
                                                  Margin="10"
                                                  VerticalAlignment="Top"
                                                  ScrollViewer.HorizontalScrollBarVisibility="Auto">
                                            <TreeView.Resources>
                                                <Style TargetType="TreeViewItem">
                                                    <Setter Property="IsExpanded" Value="True"/>
                                                </Style>
                                            </TreeView.Resources>
                                            <TreeView.ItemTemplate>
                                                <HierarchicalDataTemplate ItemsSource="{Binding Children}">
                                                    <StackPanel Orientation="Horizontal">
                                                        <!-- ファイル/フォルダアイコン -->
                                                        <ui:SymbolIcon FontSize="12" Margin="0,0,5,0">
                                                            <ui:SymbolIcon.Style>
                                                                <Style TargetType="ui:SymbolIcon">
                                                                    <Setter Property="Symbol" Value="Document16"/>
                                                                    <Style.Triggers>
                                                                        <DataTrigger Binding="{Binding IsDirectory}" Value="True">
                                                                            <Setter Property="Symbol" Value="Folder16"/>
                                                                        </DataTrigger>
                                                                    </Style.Triggers>
                                                                </Style>
                                                            </ui:SymbolIcon.Style>
                                                        </ui:SymbolIcon>

                                                        <!-- 差分アイコン -->
                                                        <ui:SymbolIcon Symbol="Delete16" FontSize="10" Margin="0,0,5,0"
                                                                       Foreground="#B40000"
                                                                       Visibility="{Binding IsDeleted, Converter={StaticResource BooleanToVisibilityConverter}}"
                                                                       ToolTip="削除されたファイル"/>

                                                        <!-- ファイル名 -->
                                                        <TextBlock Text="{Binding Name}" VerticalAlignment="Center">
                                                            <TextBlock.Style>
                                                                <Style TargetType="TextBlock">
                                                                    <Style.Triggers>
                                                                        <DataTrigger Binding="{Binding IsDeleted}" Value="True">
                                                                            <Setter Property="Foreground" Value="#B40000"/>
                                                                            <Setter Property="TextDecorations" Value="Strikethrough"/>
                                                                        </DataTrigger>
                                                                    </Style.Triggers>
                                                                </Style>
                                                            </TextBlock.Style>
                                                        </TextBlock>

                                                        <!-- ファイルサイズ -->
                                                        <TextBlock Text="{Binding DisplaySize}"
                                                                   Margin="10,0,0,0"
                                                                   FontSize="10"
                                                                   Foreground="Gray"
                                                                   VerticalAlignment="Center"/>
                                                    </StackPanel>
                                                </HierarchicalDataTemplate>
                                            </TreeView.ItemTemplate>
                                        </TreeView>
                                    </Grid>
                                </ui:Card>

                                <!-- 中央の区切り線 -->
                                <GridSplitter Grid.Column="1"
                                              VerticalAlignment="Stretch"
                                              HorizontalAlignment="Stretch"
                                              Background="Gray"
                                              ResizeBehavior="PreviousAndNext"/>

                                <!-- 右側：新構造 -->
                                <ui:Card Grid.Column="2" VerticalAlignment="Top">
                                    <Grid>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="*"/>
                                        </Grid.RowDefinitions>

                                        <Border Grid.Row="0" Background="#E6FFE6" Padding="10">
                                            <StackPanel Orientation="Horizontal">
                                                <ui:SymbolIcon Symbol="Add16" Foreground="#007800" Margin="0,0,8,0"/>
                                                <TextBlock Text="新構造" FontWeight="Bold" Foreground="#007800"/>
                                            </StackPanel>
                                        </Border>

                                        <TreeView Grid.Row="1"
                                                  ItemsSource="{Binding NewStructureTree}"
                                                  Margin="10"
                                                  VerticalAlignment="Top"
                                                  ScrollViewer.HorizontalScrollBarVisibility="Auto">
                                            <TreeView.Resources>
                                                <Style TargetType="TreeViewItem">
                                                    <Setter Property="IsExpanded" Value="True"/>
                                                </Style>
                                            </TreeView.Resources>
                                            <TreeView.ItemTemplate>
                                                <HierarchicalDataTemplate ItemsSource="{Binding Children}">
                                                    <StackPanel Orientation="Horizontal">
                                                        <!-- ファイル/フォルダアイコン -->
                                                        <ui:SymbolIcon FontSize="12" Margin="0,0,5,0">
                                                            <ui:SymbolIcon.Style>
                                                                <Style TargetType="ui:SymbolIcon">
                                                                    <Setter Property="Symbol" Value="Document16"/>
                                                                    <Style.Triggers>
                                                                        <DataTrigger Binding="{Binding IsDirectory}" Value="True">
                                                                            <Setter Property="Symbol" Value="Folder16"/>
                                                                        </DataTrigger>
                                                                    </Style.Triggers>
                                                                </Style>
                                                            </ui:SymbolIcon.Style>
                                                        </ui:SymbolIcon>

                                                        <!-- 差分アイコン -->
                                                        <ui:SymbolIcon FontSize="10" Margin="0,0,5,0">
                                                            <ui:SymbolIcon.Style>
                                                                <Style TargetType="ui:SymbolIcon">
                                                                    <Style.Triggers>
                                                                        <DataTrigger Binding="{Binding IsAdded}" Value="True">
                                                                            <Setter Property="Symbol" Value="Add16"/>
                                                                            <Setter Property="Foreground" Value="#007800"/>
                                                                            <Setter Property="ToolTip" Value="追加されたファイル"/>
                                                                            <Setter Property="Visibility" Value="Visible"/>
                                                                        </DataTrigger>
                                                                        <DataTrigger Binding="{Binding IsModified}" Value="True">
                                                                            <Setter Property="Symbol" Value="Edit16"/>
                                                                            <Setter Property="Foreground" Value="#C86400"/>
                                                                            <Setter Property="ToolTip" Value="変更されたファイル"/>
                                                                            <Setter Property="Visibility" Value="Visible"/>
                                                                        </DataTrigger>
                                                                    </Style.Triggers>
                                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                                </Style>
                                                            </ui:SymbolIcon.Style>
                                                        </ui:SymbolIcon>

                                                        <!-- ファイル名 -->
                                                        <TextBlock Text="{Binding Name}" VerticalAlignment="Center">
                                                            <TextBlock.Style>
                                                                <Style TargetType="TextBlock">
                                                                    <Style.Triggers>
                                                                        <DataTrigger Binding="{Binding IsAdded}" Value="True">
                                                                            <Setter Property="Foreground" Value="#007800"/>
                                                                            <Setter Property="FontWeight" Value="Bold"/>
                                                                        </DataTrigger>
                                                                        <DataTrigger Binding="{Binding IsModified}" Value="True">
                                                                            <Setter Property="Foreground" Value="#C86400"/>
                                                                            <Setter Property="FontWeight" Value="Bold"/>
                                                                        </DataTrigger>
                                                                    </Style.Triggers>
                                                                </Style>
                                                            </TextBlock.Style>
                                                        </TextBlock>

                                                        <!-- ファイルサイズ -->
                                                        <TextBlock Text="{Binding DisplaySize}"
                                                                   Margin="10,0,0,0"
                                                                   FontSize="10"
                                                                   Foreground="Gray"
                                                                   VerticalAlignment="Center"/>
                                                    </StackPanel>
                                                </HierarchicalDataTemplate>
                                            </TreeView.ItemTemplate>
                                        </TreeView>
                                    </Grid>
                                </ui:Card>
                            </Grid>
                        </Grid>
                    </ui:Card>
                </Grid>
            </TabItem>

            <!-- Settings Tab -->
            <TabItem Header="設定">
                <ui:Card Margin="10" VerticalAlignment="Top">
                    <StackPanel Margin="20">
                        <TextBlock Text="アプリケーション設定" FontWeight="Bold" FontSize="18" Margin="0,0,0,20"/>

                        <!-- Auto Scan Settings -->
                        <GroupBox Header="自動スキャン設定" Margin="0,0,0,15">
                            <StackPanel Margin="10">
                                <CheckBox Content="自動スキャンを有効にする"
                                         IsChecked="{Binding AutoScanEnabled}"
                                         Margin="0,0,0,10"/>

                                <TextBlock Text="※ フォルダパス変更後、自動でスキャンを開始します"
                                          FontSize="11" Foreground="Gray"/>
                            </StackPanel>
                        </GroupBox>

                        <!-- Storage Settings -->
                        <GroupBox Header="保存設定" Margin="0,0,0,15">
                            <StackPanel Margin="10">
                                <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                                    <TextBlock Text="スナップショット保存先: " VerticalAlignment="Center"/>
                                    <Grid Margin="5,0,0,0">
                                        <TextBox Text="{Binding SnapshotsDirectory}"
                                                Width="600"
                                                IsReadOnly="True"
                                                Padding="8,8,40,8"/>
                                        <ui:Button Click="ChangeSnapshotsFolder_Click"
                                                  HorizontalAlignment="Right"
                                                  VerticalAlignment="Center"
                                                  Margin="0,0,8,0"
                                                  Width="24" Height="24"
                                                  Padding="0"
                                                  Background="Transparent"
                                                  BorderThickness="0"
                                                  ToolTip="保存先を変更">
                                            <ui:SymbolIcon Symbol="FolderOpen16" FontSize="14"/>
                                        </ui:Button>
                                    </Grid>
                                </StackPanel>

                                <ui:Button Content="保存先フォルダを開く"
                                          Click="OpenSnapshotsFolder_Click"
                                          Margin="0,5,0,0"
                                          HorizontalAlignment="Left"/>
                            </StackPanel>
                        </GroupBox>

                        <!-- Snapshot Management -->
                        <GroupBox Header="スナップショット管理" Margin="0,0,0,15">
                            <StackPanel Margin="10">
                                <ui:Button Content="新しいスナップショットを作成"
                                          Command="{Binding CreateNewSnapshotCommand}"
                                          Margin="0,0,0,10"/>
                                
                                <TextBlock Text="※ フォルダを選択して新しいスナップショットを作成できます"
                                          FontSize="11" Foreground="Gray"/>
                            </StackPanel>
                        </GroupBox>

                        <!-- About -->
                        <GroupBox Header="バージョン情報">
                            <StackPanel Margin="10">
                                <TextBlock Text="ReleaseTracker" FontWeight="Bold" FontSize="14"/>
                                <TextBlock Text="Version 1.0.0" Margin="0,5,0,0"/>
                                <TextBlock Text="ディレクトリ構造比較ツール" Margin="0,5,0,0" Foreground="Gray"/>
                            </StackPanel>
                        </GroupBox>
                    </StackPanel>
                </ui:Card>
            </TabItem>
        </TabControl>

        <!-- Status Bar -->
        <Border Grid.Row="2"
                Background="{StaticResource StatusBarBackgroundBrush}"
                Margin="10,0,10,10"
                CornerRadius="4">
            <Grid Margin="15,8">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <StackPanel Grid.Column="0" Orientation="Horizontal">
                    <TextBlock Text="{Binding StatusMessage}" VerticalAlignment="Center"/>
                    <ui:ProgressRing IsIndeterminate="True"
                                     Visibility="{Binding IsProcessing, Converter={StaticResource BooleanToVisibilityConverter}}"
                                     Width="16" Height="16" Margin="10,0,0,0"/>
                </StackPanel>

                <StackPanel Grid.Column="1" Orientation="Horizontal" Visibility="{Binding HasComparisonResults, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <TextBlock Text="統計: " FontWeight="Bold"/>
                    <TextBlock Text="{Binding AddedCount}" Foreground="#007800" Margin="5,0"/>
                    <TextBlock Text="個追加" Foreground="#007800"/>
                    <TextBlock Text="," Margin="3,0"/>
                    <TextBlock Text="{Binding DeletedCount}" Foreground="#B40000" Margin="5,0"/>
                    <TextBlock Text="個削除" Foreground="#B40000"/>
                    <TextBlock Text="," Margin="3,0"/>
                    <TextBlock Text="{Binding ModifiedCount}" Foreground="#C86400" Margin="5,0"/>
                    <TextBlock Text="個変更" Foreground="#C86400"/>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</ui:FluentWindow>