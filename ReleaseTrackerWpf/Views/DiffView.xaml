<UserControl x:Class="ReleaseTrackerWpf.Views.DiffView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
             xmlns:converters="clr-namespace:ReleaseTrackerWpf.Converters">

    <UserControl.Resources>
        <converters:DifferenceTypeToColorConverter x:Key="DifferenceTypeToColorConverter"/>
        <converters:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>

        <!-- Tree Item Style with difference highlighting -->
        <Style x:Key="TreeItemStyle" TargetType="TreeViewItem">
            <Setter Property="IsExpanded" Value="True"/>
            <Setter Property="FontFamily" Value="Consolas, Monaco, 'Lucida Console', monospace"/>
            <Setter Property="FontSize" Value="12"/>
            <Style.Triggers>
                <DataTrigger Binding="{Binding DifferenceType}" Value="Added">
                    <Setter Property="Background" Value="#E6FFED"/>
                    <Setter Property="BorderBrush" Value="#28A745"/>
                    <Setter Property="BorderThickness" Value="3,0,0,0"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding DifferenceType}" Value="Deleted">
                    <Setter Property="Background" Value="#FFEEF0"/>
                    <Setter Property="BorderBrush" Value="#D73A49"/>
                    <Setter Property="BorderThickness" Value="3,0,0,0"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding DifferenceType}" Value="Modified">
                    <Setter Property="Background" Value="#FFF8E1"/>
                    <Setter Property="BorderBrush" Value="#FFC107"/>
                    <Setter Property="BorderThickness" Value="3,0,0,0"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>

        <!-- Tree View Template -->
        <HierarchicalDataTemplate x:Key="TreeItemTemplate" ItemsSource="{Binding Children}">
            <StackPanel Orientation="Horizontal">
                <!-- File/Folder icon -->
                <ui:SymbolIcon FontSize="14" Margin="0,0,8,0" VerticalAlignment="Center">
                    <ui:SymbolIcon.Style>
                        <Style TargetType="ui:SymbolIcon">
                            <Setter Property="Symbol" Value="Document16"/>
                            <Setter Property="Foreground" Value="Gray"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsDirectory}" Value="True">
                                    <Setter Property="Symbol" Value="Folder16"/>
                                    <Setter Property="Foreground" Value="#1E88E5"/>
                                </DataTrigger>
                                <DataTrigger Binding="{Binding DifferenceType}" Value="Added">
                                    <Setter Property="Foreground" Value="#28A745"/>
                                </DataTrigger>
                                <DataTrigger Binding="{Binding DifferenceType}" Value="Deleted">
                                    <Setter Property="Foreground" Value="#D73A49"/>
                                </DataTrigger>
                                <DataTrigger Binding="{Binding DifferenceType}" Value="Modified">
                                    <Setter Property="Foreground" Value="#E36209"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </ui:SymbolIcon.Style>
                </ui:SymbolIcon>

                <!-- File name -->
                <TextBlock Text="{Binding Name}"
                          VerticalAlignment="Center"
                          Foreground="{Binding DifferenceType, Converter={StaticResource DifferenceTypeToColorConverter}}"/>

                <!-- Size info (for files) -->
                <TextBlock Text="{Binding DisplaySize}"
                          FontSize="11"
                          Foreground="Gray"
                          Margin="10,0,0,0"
                          VerticalAlignment="Center"
                          Visibility="{Binding ShowSize, Converter={StaticResource BooleanToVisibilityConverter}}"/>
            </StackPanel>
        </HierarchicalDataTemplate>
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Header with statistics only -->
        <ui:Card Grid.Row="0" Margin="0,0,0,10">
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Margin="15,10">
                <TextBlock Text="差分: " FontWeight="Bold" VerticalAlignment="Center" Margin="0,0,10,0"/>
                <Border Background="#E6FFED" Padding="6,3" Margin="5,0" CornerRadius="3">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="+" Foreground="#28A745" FontWeight="Bold" Margin="0,0,3,0"/>
                        <TextBlock Text="{Binding AddedCount}" Foreground="#28A745" FontWeight="Bold"/>
                    </StackPanel>
                </Border>
                <Border Background="#FFEEF0" Padding="6,3" Margin="5,0" CornerRadius="3">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="-" Foreground="#D73A49" FontWeight="Bold" Margin="0,0,3,0"/>
                        <TextBlock Text="{Binding DeletedCount}" Foreground="#D73A49" FontWeight="Bold"/>
                    </StackPanel>
                </Border>
                <Border Background="#FFF8E1" Padding="6,3" Margin="5,0" CornerRadius="3">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="~" Foreground="#E36209" FontWeight="Bold" Margin="0,0,3,0"/>
                        <TextBlock Text="{Binding ModifiedCount}" Foreground="#E36209" FontWeight="Bold"/>
                    </StackPanel>
                </Border>
            </StackPanel>
        </ui:Card>

        <!-- Side-by-side tree comparison -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="5"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- Left tree (Old snapshot) -->
            <ScrollViewer Grid.Column="0" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Auto">
                <TreeView ItemsSource="{Binding OldTree}"
                         ItemTemplate="{StaticResource TreeItemTemplate}"
                         ItemContainerStyle="{StaticResource TreeItemStyle}"
                         Background="White"
                         BorderThickness="1"
                         BorderBrush="LightGray"/>
            </ScrollViewer>

            <!-- Splitter -->
            <GridSplitter Grid.Column="1"
                         HorizontalAlignment="Stretch"
                         VerticalAlignment="Stretch"
                         Background="LightGray"
                         ShowsPreview="True"/>

            <!-- Right tree (New snapshot) -->
            <ScrollViewer Grid.Column="2" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Auto">
                <TreeView ItemsSource="{Binding NewTree}"
                         ItemTemplate="{StaticResource TreeItemTemplate}"
                         ItemContainerStyle="{StaticResource TreeItemStyle}"
                         Background="White"
                         BorderThickness="1"
                         BorderBrush="LightGray"/>
            </ScrollViewer>
        </Grid>
    </Grid>
</UserControl>