<UserControl x:Class="ReleaseTrackerWpf.Views.DiffView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
             xmlns:converters="clr-namespace:ReleaseTrackerWpf.Converters">

    <UserControl.Resources>
        <converters:DifferenceTypeToColorConverter x:Key="DifferenceTypeToColorConverter"/>
        <converters:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>

        <!-- Data Template for comparison items -->
        <DataTemplate x:Key="ComparisonItemTemplate">
            <Border BorderThickness="0,0,0,1" BorderBrush="#E0E0E0" Padding="2">
                <Grid MinHeight="22">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="1*" MinWidth="200"/>
                        <ColumnDefinition Width="3"/>
                        <ColumnDefinition Width="1*" MinWidth="200"/>
                    </Grid.ColumnDefinitions>

                    <!-- Left side (Old snapshot) -->
                    <Border Grid.Column="0" Background="White" Padding="5,2">
                        <StackPanel Orientation="Horizontal" Margin="{Binding IndentMargin, StringFormat='{}{0},0,0,0'}">
                            <StackPanel.Style>
                                <Style TargetType="StackPanel">
                                    <Setter Property="Opacity" Value="1"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding HasLeftNode}" Value="False">
                                            <Setter Property="Opacity" Value="0.3"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </StackPanel.Style>

                            <!-- Expand/Collapse button for directories with children -->
                            <Button Width="16" Height="16" Margin="0,0,4,0"
                                   Background="Transparent" BorderThickness="0"
                                   VerticalAlignment="Center">
                                <Button.Style>
                                    <Style TargetType="Button">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                        <Style.Triggers>
                                            <MultiDataTrigger>
                                                <MultiDataTrigger.Conditions>
                                                    <Condition Binding="{Binding IsDirectory}" Value="True"/>
                                                    <Condition Binding="{Binding HasChildren}" Value="True"/>
                                                </MultiDataTrigger.Conditions>
                                                <Setter Property="Visibility" Value="Visible"/>
                                            </MultiDataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Button.Style>
                                <TextBlock FontFamily="Segoe UI Symbol" FontSize="10"
                                          HorizontalAlignment="Center" VerticalAlignment="Center">
                                    <TextBlock.Style>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="Text" Value="▶"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding IsExpanded}" Value="True">
                                                    <Setter Property="Text" Value="▼"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBlock.Style>
                                </TextBlock>
                            </Button>

                            <!-- Left File/Folder icon -->
                            <ui:SymbolIcon FontSize="14" Margin="0,0,8,0" VerticalAlignment="Center">
                                <ui:SymbolIcon.Style>
                                    <Style TargetType="ui:SymbolIcon">
                                        <Setter Property="Symbol" Value="Document16"/>
                                        <Setter Property="Foreground" Value="Gray"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding HasLeftNode}" Value="False">
                                                <Setter Property="Visibility" Value="Hidden"/>
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding IsDirectory}" Value="True">
                                                <Setter Property="Symbol" Value="Folder16"/>
                                                <Setter Property="Foreground" Value="#1E88E5"/>
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding DifferenceType}" Value="Added">
                                                <Setter Property="Foreground" Value="#28A745"/>
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding DifferenceType}" Value="Deleted">
                                                <Setter Property="Foreground" Value="#D73A49"/>
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding DifferenceType}" Value="Modified">
                                                <Setter Property="Foreground" Value="#E36209"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </ui:SymbolIcon.Style>
                            </ui:SymbolIcon>

                            <!-- Left File name -->
                            <TextBlock VerticalAlignment="Center"
                                      Foreground="{Binding DifferenceType, Converter={StaticResource DifferenceTypeToColorConverter}}"
                                      TextTrimming="CharacterEllipsis">
                                <TextBlock.Style>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="Text" Value="{Binding Name}"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding HasLeftNode}" Value="False">
                                                <Setter Property="Text" Value=""/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </TextBlock.Style>
                            </TextBlock>

                            <!-- Left Size info -->
                            <TextBlock FontSize="11"
                                      Foreground="Gray"
                                      Margin="10,0,0,0"
                                      VerticalAlignment="Center">
                                <TextBlock.Style>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="Text" Value="{Binding LeftNode.DisplaySize}"/>
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                        <Style.Triggers>
                                            <MultiDataTrigger>
                                                <MultiDataTrigger.Conditions>
                                                    <Condition Binding="{Binding HasLeftNode}" Value="True"/>
                                                    <Condition Binding="{Binding LeftNode.ShowSize}" Value="True"/>
                                                </MultiDataTrigger.Conditions>
                                                <Setter Property="Visibility" Value="Visible"/>
                                            </MultiDataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </TextBlock.Style>
                            </TextBlock>
                        </StackPanel>
                    </Border>

                    <!-- Separator -->
                    <Border Grid.Column="1" Background="#D0D0D0" Width="3"/>

                    <!-- Right side (New snapshot) -->
                    <Border Grid.Column="2" Background="White" Padding="5,2">
                        <StackPanel Orientation="Horizontal" Margin="{Binding IndentMargin, StringFormat='{}{0},0,0,0'}">
                            <StackPanel.Style>
                                <Style TargetType="StackPanel">
                                    <Setter Property="Opacity" Value="1"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding HasRightNode}" Value="False">
                                            <Setter Property="Opacity" Value="0.3"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </StackPanel.Style>

                            <!-- Spacer for expand/collapse button alignment -->
                            <Rectangle Width="20" Height="16" Fill="Transparent" Margin="0,0,4,0"/>

                            <!-- Right File/Folder icon -->
                            <ui:SymbolIcon FontSize="14" Margin="0,0,8,0" VerticalAlignment="Center">
                                <ui:SymbolIcon.Style>
                                    <Style TargetType="ui:SymbolIcon">
                                        <Setter Property="Symbol" Value="Document16"/>
                                        <Setter Property="Foreground" Value="Gray"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding HasRightNode}" Value="False">
                                                <Setter Property="Visibility" Value="Hidden"/>
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding IsDirectory}" Value="True">
                                                <Setter Property="Symbol" Value="Folder16"/>
                                                <Setter Property="Foreground" Value="#1E88E5"/>
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding DifferenceType}" Value="Added">
                                                <Setter Property="Foreground" Value="#28A745"/>
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding DifferenceType}" Value="Deleted">
                                                <Setter Property="Foreground" Value="#D73A49"/>
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding DifferenceType}" Value="Modified">
                                                <Setter Property="Foreground" Value="#E36209"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </ui:SymbolIcon.Style>
                            </ui:SymbolIcon>

                            <!-- Right File name -->
                            <TextBlock VerticalAlignment="Center"
                                      Foreground="{Binding DifferenceType, Converter={StaticResource DifferenceTypeToColorConverter}}"
                                      TextTrimming="CharacterEllipsis">
                                <TextBlock.Style>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="Text" Value="{Binding Name}"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding HasRightNode}" Value="False">
                                                <Setter Property="Text" Value=""/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </TextBlock.Style>
                            </TextBlock>

                            <!-- Right Size info -->
                            <TextBlock FontSize="11"
                                      Foreground="Gray"
                                      Margin="10,0,0,0"
                                      VerticalAlignment="Center">
                                <TextBlock.Style>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="Text" Value="{Binding RightNode.DisplaySize}"/>
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                        <Style.Triggers>
                                            <MultiDataTrigger>
                                                <MultiDataTrigger.Conditions>
                                                    <Condition Binding="{Binding HasRightNode}" Value="True"/>
                                                    <Condition Binding="{Binding RightNode.ShowSize}" Value="True"/>
                                                </MultiDataTrigger.Conditions>
                                                <Setter Property="Visibility" Value="Visible"/>
                                            </MultiDataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </TextBlock.Style>
                            </TextBlock>
                        </StackPanel>
                    </Border>
                </Grid>
                <!-- Background styling based on difference type -->
                <Border.Style>
                    <Style TargetType="Border">
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding DifferenceType}" Value="Added">
                                <Setter Property="Background" Value="#E6FFED"/>
                            </DataTrigger>
                            <DataTrigger Binding="{Binding DifferenceType}" Value="Deleted">
                                <Setter Property="Background" Value="#FFEEF0"/>
                            </DataTrigger>
                            <DataTrigger Binding="{Binding DifferenceType}" Value="Modified">
                                <Setter Property="Background" Value="#FFF8E1"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </Border.Style>
            </Border>
        </DataTemplate>
    </UserControl.Resources>

    <!-- Unified comparison tree -->
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Header with snapshot names -->
        <Border Grid.Row="0" Background="#F5F5F5" Padding="10,5">
            <Grid>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="5"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <TextBlock Grid.Column="0"
                      Text="{Binding OldSnapshotName}"
                      FontWeight="Bold"
                      HorizontalAlignment="Center"/>

            <Border Grid.Column="1" Background="LightGray" Width="1"/>

            <TextBlock Grid.Column="2"
                      Text="{Binding NewSnapshotName}"
                      FontWeight="Bold"
                      HorizontalAlignment="Center"/>
            </Grid>
        </Border>

        <!-- Unified comparison list -->
        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Auto">
            <ItemsControl ItemsSource="{Binding ComparisonItems}"
                         ItemTemplate="{StaticResource ComparisonItemTemplate}"
                         Background="White"
                         BorderThickness="1"
                         BorderBrush="LightGray"
                         Padding="5">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <StackPanel Orientation="Vertical"/>
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
            </ItemsControl>
        </ScrollViewer>
    </Grid>
</UserControl>